volumes:
  ep_weave_postgres_data_vol:
    external: false
  ep_weave_solr_data_vol:
    external: false

services:
  ep-weave-solr:
    build:
      context: ./images/ep_weave/ep_weave
      dockerfile: solr/Dockerfile
    volumes:
      - ep_weave_solr_data_vol:/var/solr/
    restart: always
    networks:
      - backend

  ep-weave-postgresql:
    image: postgres:15
    environment:
      POSTGRES_DB: etherpad
      POSTGRES_USER: etherpaduser
      POSTGRES_PASSWORD: etherpadpass
    volumes:
      - ep_weave_postgres_data_vol:/var/lib/postgresql/data/
    restart: always
    networks:
      - backend

  ep-weave-etherpad:
    build:
      context: ./images/ep_weave/ep_weave
      dockerfile: Dockerfile
    environment:
      DB_HOST: ep-weave-postgresql
      DB_NAME: etherpad
      DB_PASS: etherpadpass
      DB_PORT: 5432
      DB_TYPE: postgres
      DB_USER: etherpaduser
      LOGLEVEL: "debug"
      REQUIRE_AUTHENTICATION: "true"
      EP_WEAVE_OAUTH_CLIENT_ID: ${EP_WEAVE_OAUTH_CLIENT_ID:-ep_weave_oauth_client}
      EP_WEAVE_OAUTH_CLIENT_SECRET: ${EP_WEAVE_OAUTH_CLIENT_SECRET:-ep_weave_oauth_secret}
      EP_WEAVE_BASE_URL: "https://${SERVER_NAME}/services/ep_weave/"
    volumes:
      - ./images/ep_weave/settings/local.json:/opt/etherpad-lite/settings.json:ro
    depends_on:
      - ep-weave-postgresql
      - ep-weave-solr
      - jupyterhub
    restart: always
    networks:
      - backend

  ep-weave-etherpad-proxy:
    build:
      context: ./images/ep_weave-etherpad-proxy
    depends_on:
      - ep-weave-etherpad
    restart: always
    networks:
      - backend

  jupyterhub:
    # Override NBSEARCHDB_* environment variables
    environment:
    #   NBSEARCHDB_SOLR_BASE_URL: "${NBSEARCHDB_SOLR_BASE_URL:-http://nbsearch-solr:8983}"
    #   NBSEARCHDB_SOLR_BASIC_AUTH_USERNAME: "${NBSEARCHDB_SOLR_BASIC_AUTH_USERNAME:-}"
    #   NBSEARCHDB_SOLR_BASIC_AUTH_PASSWORD: "${NBSEARCHDB_SOLR_BASIC_AUTH_PASSWORD:-}"
    #   NBSEARCHDB_S3_ENDPOINT_URL: "${NBSEARCHDB_S3_ENDPOINT_URL:-http://nbsearch-minio:9000}"
    #   NBSEARCHDB_S3_ACCESS_KEY: "${NBSEARCHDB_S3_ACCESS_KEY:-nbsearchak}"
    #   NBSEARCHDB_S3_SECRET_KEY: "${NBSEARCHDB_S3_SECRET_KEY:-nbsearchsk}"
    #   NBSEARCHDB_S3_REGION_NAME: "${NBSEARCHDB_S3_REGION_NAME:-}"
    #   NBSEARCHDB_S3_BUCKET_NAME: "${NBSEARCHDB_S3_BUCKET_NAME:-notebooks}"
    #   NBSEARCHDB_SOLR_NOTEBOOK: "${NBSEARCHDB_SOLR_NOTEBOOK:-jupyter-notebook}"
    #   NBSEARCHDB_SOLR_CELL: "${NBSEARCHDB_SOLR_CELL:-jupyter-cell}"
    #   NBSEARCHDB_MY_SERVER_URL: "${NBSEARCHDB_MY_SERVER_URL:-http://localhost:8888/}"
    #   NBSEARCHDB_AUTO_UPDATE: "0"
      EP_WEAVE_OAUTH_CLIENT_ID: ${EP_WEAVE_OAUTH_CLIENT_ID:-ep_weave_oauth_client}
      EP_WEAVE_OAUTH_CLIENT_SECRET: ${EP_WEAVE_OAUTH_CLIENT_SECRET:-ep_weave_oauth_secret}
      SERVER_NAME: "${SERVER_NAME}"
    volumes:
      - './config/ep_weave/jupyterhub_config.py:/jupyterhub_config.d/ep_weave.py:ro'
